input {
  beats {
    port => 5044
  }
}

filter {
  # Traitement des logs
  if "autorun_decide" in [tags] or "autorun_control" in [tags] {
    grok {
      match => [
        "message",
        "%{DATE:date} - %{TIME:time},%{INT:millis} - %{WORD:bench} - %{WORD:node} - %{WORD:type} - %{WORD:context} - %{GREEDYDATA:text}"
      ]
    }
  }
  else if "hil_synthesis_backend" in [tags] {
    grok {
      match => [
        "message",
        "%{DATE:date} - %{TIME:time},%{INT:millis} - %{WORD:system} - %{WORD:node} - %{WORD:type} - %{WORD:context} - %{GREEDYDATA:text}"
      ]
    }
  }

  # Traitement des donnÃ©es de synthÃ¨se
  else if "kpi_variable" in [tags] {
    csv {
      source => "message"
      separator => ","
      columns => ["id","name","value","group_type","references"]
    }
    mutate {
      convert => { "value" => "integer" }
    }
    date { match => ["created_at","ISO8601"] target => "@timestamp" }
    date { match => ["updated_at","ISO8601"] target => "updated_at" }
  }

  else if "procedure" in [tags] {
    csv {
      source => "message"
      separator => ","
      columns => ["id","reference","revision","status"]
    }
    mutate { convert => { "revision" => "integer" } }
  }

  else if "comment" in [tags] {
    csv {
      source => "message"
      separator => ","
      columns => ["id","info","warning","error"]
    }
    mutate {
      convert => {
        "info"    => "integer"
        "warning" => "integer"
        "error"   => "integer"
      }
    }
    date { match => ["created_at","ISO8601"] target => "@timestamp" }
    date { match => ["updated_at","ISO8601"] target => "updated_at" }
  }

  else if "procedure_definition" in [tags] {
    csv {
      source => "message"
      separator => ","
      columns => ["id","created_at","updated_at","total_testruns","total_empty_testruns","total_steps","total_AC","total_CO","total_ER","procedure_reference","procedure_revision","procedure_status","comment_info","comment_warning","comment_error"]
    }

    mutate {
      convert => {
        "total_testruns"     => "integer"
        "total_empty_testruns"     => "integer"
        "total_steps"        => "integer"
        "total_AC"           => "integer"
        "total_CO"           => "integer"
        "total_ER"           => "integer"
        "procedure_revision" => "integer"
        "comment_info"       => "integer"
        "comment_warning"    => "integer"
        "comment_error"      => "integer"
      }
    }
    date { match => ["created_at","ISO8601"] target => "@timestamp" }
    date { match => ["updated_at","ISO8601"] target => "updated_at" }
  }

  else if "procedure_digitalization" in [tags] {
    csv {
      source => "message"
      separator => ","
      columns => ["id","created_at","updated_at","total_testruns_digitalized","total_AC_digitalized","total_ER_digitalized","total_IC_digitalized","total_CO_digitalized","procedure_reference","procedure_revision","procedure_status","comment_info","comment_warning","comment_error"]
    }
    mutate {
      convert => {
        "total_testruns_digitalized" => "integer"
        "total_AC_digitalized"       => "integer"
        "total_ER_digitalized"       => "integer"
        "total_IC_digitalized"       => "integer"
        "total_CO_digitalized"       => "integer"
        "procedure_revision"         => "integer"
        "comment_info"               => "integer"
        "comment_warning"            => "integer"
        "comment_error"              => "integer"
      }
    }
    date { match => ["created_at","ISO8601"] target => "@timestamp" }
    date { match => ["updated_at","ISO8601"] target => "updated_at" }
  }
  
}

output {
  if "autorun_decide" in [tags] {
    elasticsearch { hosts => ["http://elasticsearch:9200"] index => "hil-monitor-index" }
  }

  else if "autorun_control" in [tags] {
    elasticsearch { hosts => ["http://elasticsearch:9200"] index => "hil-monitor-index" }
  }

  else if "hil_synthesis_backend" in [tags] {
    elasticsearch { hosts => ["http://elasticsearch:9200"] index => "hil-monitor-index" }
  }

  else if "kpi_variable" in [tags] {
    elasticsearch { hosts => ["http://elasticsearch:9200"] index => "kpi_variable-index" }
    elasticsearch { hosts => ["http://elasticsearch:9200"] index => "hil-synthesis-index" }
  }

  else if "procedure" in [tags] {
    elasticsearch { hosts => ["http://elasticsearch:9200"] index => "procedure-index" }
    elasticsearch { hosts => ["http://elasticsearch:9200"] index => "hil-synthesis-index" }
  }

  else if "comment" in [tags] {
    elasticsearch { hosts => ["http://elasticsearch:9200"] index => "comment-index" }
    elasticsearch { hosts => ["http://elasticsearch:9200"] index => "hil-synthesis-index" }
  }

  else if "procedure_definition" in [tags] {
    elasticsearch { hosts => ["http://elasticsearch:9200"] index => "procedure_definition-index" }
    elasticsearch { hosts => ["http://elasticsearch:9200"] index => "hil-synthesis-index" }
  }

  else if "procedure_digitalization" in [tags] {
    elasticsearch { hosts => ["http://elasticsearch:9200"] index => "procedure_digitalization-index" }
    elasticsearch { hosts => ["http://elasticsearch:9200"] index => "hil-synthesis-index" }
  }
  # fallback
  else {
    elasticsearch { hosts => ["http://elasticsearch:9200"] index => "hil-synthesis-index" }
  }

  stdout { codec => rubydebug }
}